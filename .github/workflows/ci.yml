# =============================================================================
# TraveNest CI Pipeline
# =============================================================================
# This pipeline runs on ALL commits to ensure code quality and prevent regressions.
# Tests are mandatory and must pass before any merge.
# =============================================================================

name: CI - Test & Validate

on:
    # Run on all pushes to any branch
    push:
        branches:
            - "**"
    # Run on all pull requests
    pull_request:
        branches:
            - main
            - develop
            - "release/**"
    # Allow manual trigger
    workflow_dispatch:

# Cancel in-progress runs for the same branch
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    NODE_VERSION: "20"
    PNPM_VERSION: "9.15.0"

jobs:
    # ===========================================================================
    # Dependency Installation & Caching
    # ===========================================================================
    setup:
        name: Setup Dependencies
        runs-on: ubuntu-latest
        outputs:
            cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Get pnpm store directory
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

            - name: Cache pnpm store
              id: cache-deps
              uses: actions/cache@v4
              with:
                  path: ${{ env.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

    # ===========================================================================
    # Linting - Code Quality Check
    # ===========================================================================
    lint:
        name: Lint Code
        runs-on: ubuntu-latest
        needs: setup
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run Linting
              run: pnpm lint

    # ===========================================================================
    # Type Checking - TypeScript Validation
    # ===========================================================================
    typecheck:
        name: TypeScript Check
        runs-on: ubuntu-latest
        needs: setup
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Generate Prisma Client
              run: pnpm db:generate

            - name: Run TypeScript Check
              run: pnpm -r exec tsc --noEmit

    # ===========================================================================
    # API Tests - Backend Regression Testing
    # ===========================================================================
    test-api:
        name: API Tests
        runs-on: ubuntu-latest
        needs: setup
        services:
            # PostgreSQL service for integration tests
            postgres:
                image: postgres:16-alpine
                env:
                    POSTGRES_USER: test
                    POSTGRES_PASSWORD: test
                    POSTGRES_DB: travenest_test
                ports:
                    - 5432:5432
                options: >-
                    --health-cmd pg_isready
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5

        env:
            DATABASE_URL: postgresql://test:test@localhost:5432/travenest_test
            JWT_SECRET: test-jwt-secret-for-ci-pipeline
            JWT_REFRESH_SECRET: test-refresh-secret-for-ci-pipeline
            NODE_ENV: test

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Generate Prisma Client
              run: pnpm db:generate

            - name: Push Database Schema
              run: pnpm db:push

            - name: Run API Tests
              run: pnpm --filter @travenest/api test

            - name: Run API Tests with Coverage
              run: pnpm --filter @travenest/api test:coverage

            - name: Upload Coverage Report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: api-coverage-report
                  path: apps/api/coverage/
                  retention-days: 7

    # ===========================================================================
    # Build Check - Ensure All Packages Build Successfully
    # ===========================================================================
    build:
        name: Build All Packages
        runs-on: ubuntu-latest
        needs: [lint, typecheck]
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Generate Prisma Client
              run: pnpm db:generate

            - name: Build API
              run: pnpm build:api

            - name: Build Web
              run: pnpm build:web
              env:
                  # Skip type errors during build for now (Next.js)
                  SKIP_ENV_VALIDATION: true

            - name: Upload API Build Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: api-build
                  path: apps/api/dist/
                  retention-days: 7

            - name: Upload Web Build Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: web-build
                  path: apps/web/.next/
                  retention-days: 7

    # ===========================================================================
    # Security Audit - Check for Vulnerabilities
    # ===========================================================================
    security:
        name: Security Audit
        runs-on: ubuntu-latest
        needs: setup
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: ${{ env.PNPM_VERSION }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "pnpm"

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Run Security Audit
              run: pnpm audit --audit-level=high
              continue-on-error: true # Don't fail on audit warnings

    # ===========================================================================
    # Final Status Check - All Tests Must Pass
    # ===========================================================================
    ci-status:
        name: CI Status Check
        runs-on: ubuntu-latest
        needs: [lint, typecheck, test-api, build, security]
        if: always()
        steps:
            - name: Check CI Status
              run: |
                  if [[ "${{ needs.lint.result }}" != "success" ]] || \
                     [[ "${{ needs.typecheck.result }}" != "success" ]] || \
                     [[ "${{ needs.test-api.result }}" != "success" ]] || \
                     [[ "${{ needs.build.result }}" != "success" ]]; then
                    echo "CI checks failed!"
                    echo "Lint: ${{ needs.lint.result }}"
                    echo "TypeCheck: ${{ needs.typecheck.result }}"
                    echo "API Tests: ${{ needs.test-api.result }}"
                    echo "Build: ${{ needs.build.result }}"
                    exit 1
                  fi
                  echo "All CI checks passed!"
